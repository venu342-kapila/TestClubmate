<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ClubMates â€” Admin Dashboard</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  :root { --primary:#1B5E20; --bg:#F5F6F8; --card:#fff; --text:#1A1A1A; --muted:#888; --border:#EBEBEB; }
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
  .container { max-width:800px; margin:0 auto; padding:16px; }

  /* Header */
  .header { background:var(--primary); color:white; padding:16px 20px; display:flex; align-items:center; justify-content:space-between; }
  .header h1 { font-size:18px; font-weight:700; }
  .header .badge { background:rgba(255,255,255,.2); padding:4px 10px; border-radius:20px; font-size:12px; font-weight:600; }
  .header button { background:rgba(255,255,255,.15); color:white; border:none; padding:6px 14px; border-radius:8px; font-size:12px; cursor:pointer; }

  /* Stats row */
  .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; margin:16px 0; }
  .stat-card { background:var(--card); padding:16px; border-radius:12px; text-align:center; }
  .stat-card .num { font-size:28px; font-weight:700; color:var(--primary); }
  .stat-card .label { font-size:12px; color:var(--muted); margin-top:4px; }

  /* Search & sort */
  .toolbar { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
  .toolbar input { flex:1; min-width:200px; padding:10px 12px; border:1.5px solid var(--border); border-radius:10px; font-size:14px; outline:none; }
  .toolbar select { padding:10px; border:1.5px solid var(--border); border-radius:10px; font-size:13px; background:var(--card); }

  /* Table */
  .table-wrap { overflow-x:auto; background:var(--card); border-radius:12px; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  th { background:#F5F6F8; text-align:left; padding:10px 12px; font-weight:600; color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.5px; white-space:nowrap; }
  td { padding:10px 12px; border-top:1px solid var(--border); vertical-align:top; }
  tr:hover td { background:#FAFAFA; }
  .club-name { font-weight:600; color:var(--primary); }
  .club-logo { width:28px; height:28px; border-radius:6px; vertical-align:middle; margin-right:6px; }
  .member-count { background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600; }
  .date { color:var(--muted); font-size:12px; white-space:nowrap; }

  /* Sign-in */
  .signin-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:80vh; text-align:center; }
  .signin-screen h2 { color:var(--primary); margin-bottom:8px; }
  .signin-screen p { color:var(--muted); margin-bottom:24px; font-size:14px; }
  .signin-btn { display:inline-flex; align-items:center; gap:10px; padding:12px 24px; border:1.5px solid var(--border); border-radius:12px; background:var(--card); font-size:15px; font-weight:600; cursor:pointer; }
  .signin-btn:hover { border-color:var(--primary); }

  /* Denied */
  .denied { text-align:center; padding:60px 20px; }
  .denied h2 { color:#D32F2F; margin-bottom:8px; }
  .denied p { color:var(--muted); font-size:14px; }

  /* Loading */
  .loading { text-align:center; padding:60px; color:var(--muted); font-size:14px; }

  /* Responsive */
  @media(max-width:600px) {
    .stats { grid-template-columns:1fr 1fr; }
    table { font-size:12px; }
    td, th { padding:8px; }
  }
</style>
</head>
<body>

<div id="signinScreen" class="signin-screen" style="display:none;">
  <div style="font-size:48px;margin-bottom:16px;">ğŸ›¡ï¸</div>
  <h2>Admin Dashboard</h2>
  <p>Sign in with your Google account to continue</p>
  <button class="signin-btn" onclick="doSignIn()">
    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
    Sign in with Google
  </button>
</div>

<div id="deniedScreen" class="denied" style="display:none;">
  <div style="font-size:48px;margin-bottom:16px;">ğŸš«</div>
  <h2>Access Denied</h2>
  <p>Your account is not authorized to view this dashboard.</p>
  <p style="margin-top:12px;font-size:12px;color:#bbb;" id="deniedUid"></p>
  <button onclick="firebase.auth().signOut()" style="margin-top:16px;padding:8px 20px;border:1.5px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;font-size:13px;">Sign Out</button>
</div>

<div id="adminApp" style="display:none;">
  <div class="header">
    <div>
      <h1>ğŸ›¡ï¸ ClubMates Admin</h1>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span class="badge" id="adminEmail"></span>
      <button onclick="firebase.auth().signOut()">Sign Out</button>
    </div>
  </div>

  <div class="container">
    <div class="stats">
      <div class="stat-card"><div class="num" id="statClubs">â€”</div><div class="label">Total Clubs</div></div>
      <div class="stat-card"><div class="num" id="statMembers">â€”</div><div class="label">Total Members</div></div>
      <div class="stat-card"><div class="num" id="statTxns">â€”</div><div class="label">Total Transactions</div></div>
      <div class="stat-card"><div class="num" id="statThisMonth">â€”</div><div class="label">New This Month</div></div>
    </div>

    <div class="toolbar">
      <input type="text" id="clubSearch" placeholder="Search clubs..." oninput="filterClubs()" />
      <select id="clubSort" onchange="filterClubs()">
        <option value="created-desc">Newest First</option>
        <option value="created-asc">Oldest First</option>
        <option value="name-asc">Name Aâ†’Z</option>
        <option value="members-desc">Most Members</option>
      </select>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Club</th>
            <th>Owner</th>
            <th>Members</th>
            <th>Txns</th>
            <th>Currency</th>
            <th>Approval</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody id="clubTableBody">
          <tr><td colspan="8" class="loading">Loading clubs...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top:24px;text-align:center;font-size:11px;color:var(--muted);">
      ClubMates Admin Dashboard Â· Data refreshes on page load Â· <a href="#" onclick="loadAllClubs();return false;" style="color:var(--primary);">Refresh Now</a>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Firebase + Admin Config
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  firebase.initializeApp({
    apiKey: "AIzaSyBSu_h8iKIHZEkY5XLtoiEhWpcQY81ucAg",
    authDomain: "club-expense-tracking.firebaseapp.com",
    projectId: "club-expense-tracking",
    storageBucket: "club-expense-tracking.firebasestorage.app",
    messagingSenderId: "281245643064",
    appId: "1:281245643064:web:6677ac96778cebb26151cd"
  });
  var auth = firebase.auth();
  var db = firebase.firestore();

  // â”€â”€â”€ SUPER-USER ALLOW-LIST â”€â”€â”€
  // Add your Google UID(s) here. Find yours in the "Access Denied" screen.
  // Your UID is shown there after you sign in.
  var SUPER_USERS = [
    // 'paste-your-firebase-uid-here'
      'D2mOB76XnNOAjao03kamfamkCkf1'
  ];

  // If the allow-list is empty, allow ANY authenticated user (for initial setup).
  // Once you add your UID, only those UIDs can access this page.
  function isSuperUser(uid) {
    return SUPER_USERS.length === 0 || SUPER_USERS.indexOf(uid) !== -1;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // State
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var allClubs = [];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Auth
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  auth.onAuthStateChanged(function(user) {
    document.getElementById('signinScreen').style.display = 'none';
    document.getElementById('deniedScreen').style.display = 'none';
    document.getElementById('adminApp').style.display = 'none';

    if (!user) {
      document.getElementById('signinScreen').style.display = 'flex';
      return;
    }

    if (!isSuperUser(user.uid)) {
      document.getElementById('deniedScreen').style.display = 'block';
      document.getElementById('deniedUid').textContent = 'Your UID: ' + user.uid;
      return;
    }

    document.getElementById('adminApp').style.display = 'block';
    document.getElementById('adminEmail').textContent = user.email;
    loadAllClubs();
  });

  function doSignIn() {
    var provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(function(err) {
      alert('Sign-in error: ' + err.message);
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Load Clubs + Member/Txn Counts
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function loadAllClubs() {
    document.getElementById('clubTableBody').innerHTML = '<tr><td colspan="8" class="loading">Loading clubs...</td></tr>';

    db.collection('clubs').get().then(function(snap) {
      var clubs = [];
      var promises = [];

      snap.forEach(function(doc) {
        var data = doc.data();
        var club = {
          id: doc.id,
          name: data.name || '(unnamed)',
          currency: data.currency || 'â‚¹',
          requireApproval: !!data.requireApproval,
          logoBase64: data.logoBase64 || null,
          createdBy: data.createdBy || null,
          createdAt: data.createdAt ? data.createdAt.toDate() : null,
          memberCount: 0,
          txnCount: 0,
          ownerName: 'â€”',
          ownerEmail: 'â€”'
        };
        clubs.push(club);

        // Fetch member count + owner info
        var memberPromise = db.collection('clubs').doc(doc.id).collection('members').get()
          .then(function(mSnap) {
            club.memberCount = mSnap.size;
            // Find owner
            mSnap.forEach(function(m) {
              if (m.data().role === 'owner') {
                club.ownerName = m.data().name || m.data().email || 'â€”';
                club.ownerEmail = m.data().email || '';
              }
            });
          }).catch(function() {});

        // Fetch transaction count
        var txnPromise = db.collection('clubs').doc(doc.id).collection('transactions').get()
          .then(function(tSnap) {
            club.txnCount = tSnap.size;
          }).catch(function() {});

        promises.push(memberPromise, txnPromise);
      });

      return Promise.all(promises).then(function() {
        allClubs = clubs;
        updateStats();
        filterClubs();
      });
    }).catch(function(err) {
      document.getElementById('clubTableBody').innerHTML =
        '<tr><td colspan="8" class="loading" style="color:#D32F2F;">Error: ' + err.message + '</td></tr>';
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Stats
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function updateStats() {
    document.getElementById('statClubs').textContent = allClubs.length;
    var totalMembers = allClubs.reduce(function(s, c) { return s + c.memberCount; }, 0);
    var totalTxns = allClubs.reduce(function(s, c) { return s + c.txnCount; }, 0);
    document.getElementById('statMembers').textContent = totalMembers;
    document.getElementById('statTxns').textContent = totalTxns;

    // New clubs this month
    var now = new Date();
    var thisMonth = allClubs.filter(function(c) {
      return c.createdAt && c.createdAt.getMonth() === now.getMonth() && c.createdAt.getFullYear() === now.getFullYear();
    }).length;
    document.getElementById('statThisMonth').textContent = thisMonth;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Filter & Sort
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function filterClubs() {
    var query = (document.getElementById('clubSearch').value || '').toLowerCase();
    var sort = document.getElementById('clubSort').value;

    var list = allClubs.slice();

    // Filter
    if (query) {
      list = list.filter(function(c) {
        return c.name.toLowerCase().indexOf(query) !== -1 ||
               c.ownerName.toLowerCase().indexOf(query) !== -1 ||
               c.ownerEmail.toLowerCase().indexOf(query) !== -1 ||
               c.id.toLowerCase().indexOf(query) !== -1;
      });
    }

    // Sort
    if (sort === 'created-desc') {
      list.sort(function(a, b) { return (b.createdAt || 0) - (a.createdAt || 0); });
    } else if (sort === 'created-asc') {
      list.sort(function(a, b) { return (a.createdAt || 0) - (b.createdAt || 0); });
    } else if (sort === 'name-asc') {
      list.sort(function(a, b) { return a.name.localeCompare(b.name); });
    } else if (sort === 'members-desc') {
      list.sort(function(a, b) { return b.memberCount - a.memberCount; });
    }

    renderTable(list);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Render
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderTable(list) {
    if (list.length === 0) {
      document.getElementById('clubTableBody').innerHTML =
        '<tr><td colspan="8" class="loading">No clubs found</td></tr>';
      return;
    }

    var html = '';
    list.forEach(function(c, i) {
      var dateStr = c.createdAt ? formatDate(c.createdAt) : 'â€”';
      var logoHtml = c.logoBase64
        ? '<img class="club-logo" src="' + c.logoBase64 + '" alt="" />'
        : '<span style="display:inline-block;width:28px;height:28px;border-radius:6px;background:#E8F5E9;text-align:center;line-height:28px;font-size:14px;margin-right:6px;">ğŸ</span>';

      html += '<tr>';
      html += '<td>' + (i + 1) + '</td>';
      html += '<td>' + logoHtml + '<span class="club-name">' + esc(c.name) + '</span><br><span style="font-size:10px;color:var(--muted);">' + esc(c.id) + '</span></td>';
      html += '<td>' + esc(c.ownerName) + '<br><span style="font-size:11px;color:var(--muted);">' + esc(c.ownerEmail) + '</span></td>';
      html += '<td><span class="member-count">' + c.memberCount + '</span></td>';
      html += '<td>' + c.txnCount + '</td>';
      html += '<td style="text-align:center;">' + esc(c.currency) + '</td>';
      html += '<td>' + (c.requireApproval ? 'âœ…' : 'â€”') + '</td>';
      html += '<td class="date">' + dateStr + '</td>';
      html += '</tr>';
    });

    document.getElementById('clubTableBody').innerHTML = html;
  }

  function formatDate(d) {
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
  }

  function esc(s) {
    var d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  }
</script>
</body>
</html>
